SELECT DUNO.ASSET_CODE, DUNO.MA_TK, DUNO.SO_DU, (DUNO.SO_TIEN-DUCO.SO_TIEN) AS SO_TIEN 
FROM 
	(SELECT CDKT.ASSET_CODE, CDKT.MA_TK, CDKT.SO_DU, SUM(NVKT.SO_TIEN) AS SO_TIEN 
	FROM CHUNG_TU AS CT, CHUNG_TU_NVKT AS CTNVKT, NGHIEP_VU_KE_TOAN AS NVKT, CDKT_TAIKHOAN AS CDKT, TAI_KHOAN_DANH_MUC AS TKDM 
	WHERE CT.MA_CT=CTNVKT.MA_CT AND CTNVKT.MA_NVKT=NVKT.MA_NVKT AND SUBSTRING(NVKT.MA_TK, 1, LENGTH(CDKT.MA_TK))=CDKT.MA_TK AND NVKT.MA_TK=TKDM.MA_TK 
		AND TKDM.LUONG_TINH=0 AND NVKT.SO_DU=-1 AND CT.NGAY_HT >= '2018-1-01' AND CT.NGAY_HT <= '2018-12-31' 
		AND ((CDKT.ASSET_CODE='112' AND ((CDKT.MA_TK='1281' AND (CT.NGAY_TT IS NULL OR CT.NGAY_TT-INTERVAL 3 MONTH <= CT.NGAY_HT)) OR (CDKT.MA_TK='1288' AND (CT.NGAY_TT IS NULL OR CT.NGAY_TT - INTERVAL 3 MONTH <= CURDATE())))) OR 
		(CDKT.ASSET_CODE='123' AND CT.NGAY_TT - INTERVAL 3 MONTH > CURDATE() AND CT.NGAY_TT - INTERVAL 12 MONTH <= CURDATE()) OR 
		(CDKT.ASSET_CODE IN ('131', '132', '133', '135', '136', '137', '141', '149', '155', '311', '312', '315', '316', '318', '319', '320', '321') AND (CT.NGAY_TT IS NULL OR CT.NGAY_TT - INTERVAL 12 MONTH <= CURDATE())) OR 
		(CDKT.ASSET_CODE IN ('151') AND (CT.NGAY_TT IS NULL OR CT.NGAY_TT-INTERVAL 12 MONTH <= CT.NGAY_HT)) OR 
		(CDKT.ASSET_CODE IN ('211', '212', '214', '215', '216', '219', '241', '255', '263', '268', '331', '332', '333', '335', '336', '337', '338', '342') AND CT.NGAY_TT - INTERVAL 12 MONTH > CURDATE()) OR 
		(CDKT.ASSET_CODE IN ('261') AND CT.NGAY_TT-INTERVAL 12 MONTH > CT.NGAY_HT) OR 
		CDKT.ASSET_CODE NOT IN ('112', '123', '131', '132', '133', '135', '136', '137', '141', '149', '151', '155', '211', '212', '214', '215', '216', '219', '241', '255', '261', '263', '268', 
			'311', '312', '315', '316', '318', '319', '320', '321', '331', '332', '333', '335', '336', '337', '338', '342')) 
	GROUP BY CDKT.ASSET_CODE, CDKT.MA_TK) AS DUNO, 
	(SELECT CDKT.ASSET_CODE, CDKT.MA_TK, CDKT.SO_DU, TKDM.LUONG_TINH, SUM(NVKT.SO_TIEN) AS SO_TIEN 
	FROM CHUNG_TU AS CT, CHUNG_TU_NVKT AS CTNVKT, NGHIEP_VU_KE_TOAN AS NVKT, CDKT_TAIKHOAN AS CDKT, TAI_KHOAN_DANH_MUC AS TKDM 
	WHERE CT.MA_CT=CTNVKT.MA_CT AND CTNVKT.MA_NVKT=NVKT.MA_NVKT AND SUBSTRING(NVKT.MA_TK, 1, LENGTH(CDKT.MA_TK))=CDKT.MA_TK AND NVKT.MA_TK=TKDM.MA_TK 
		AND TKDM.LUONG_TINH=0 AND NVKT.SO_DU=1 AND CT.NGAY_HT >= '2018-1-01' AND CT.NGAY_HT <= '2018-12-31' 
		AND ((CDKT.ASSET_CODE='112' AND ((CDKT.MA_TK='1281' AND (CT.NGAY_TT IS NULL OR CT.NGAY_TT-INTERVAL 3 MONTH <= CT.NGAY_HT)) OR (CDKT.MA_TK='1288' AND (CT.NGAY_TT IS NULL OR CT.NGAY_TT - INTERVAL 3 MONTH <= CURDATE())))) OR 
		(CDKT.ASSET_CODE='123' AND CT.NGAY_TT - INTERVAL 3 MONTH > CURDATE() AND CT.NGAY_TT - INTERVAL 12 MONTH <= CURDATE()) OR 
		(CDKT.ASSET_CODE IN ('131', '132', '133', '135', '136', '137', '141', '149', '155', '311', '312', '315', '316', '318', '319', '320', '321') AND (CT.NGAY_TT IS NULL OR CT.NGAY_TT - INTERVAL 12 MONTH <= CURDATE())) OR 
		(CDKT.ASSET_CODE IN ('151') AND (CT.NGAY_TT IS NULL OR CT.NGAY_TT-INTERVAL 12 MONTH <= CT.NGAY_HT)) OR 
		(CDKT.ASSET_CODE IN ('211', '212', '214', '215', '216', '219', '241', '255', '263', '268', '331', '332', '333', '335', '336', '337', '338', '342') AND CT.NGAY_TT - INTERVAL 12 MONTH > CURDATE()) OR 
		(CDKT.ASSET_CODE IN ('261') AND CT.NGAY_TT-INTERVAL 12 MONTH > CT.NGAY_HT) OR 
		CDKT.ASSET_CODE NOT IN ('112', '123', '131', '132', '133', '135', '136', '137', '141', '149', '151', '155', '211', '212', '214', '215', '216', '219', '241', '255', '261', '263', '268', 
			'311', '312', '315', '316', '318', '319', '320', '321', '331', '332', '333', '335', '336', '337', '338', '342')) 
	GROUP BY CDKT.ASSET_CODE, CDKT.MA_TK) AS DUCO
WHERE DUNO.ASSET_CODE=DUCO.ASSET_CODE AND DUNO.MA_TK=DUCO.MA_TK
UNION
SELECT CDKT.ASSET_CODE, CDKT.MA_TK, CDKT.SO_DU, SUM(NVKT.SO_TIEN) AS SO_TIEN 
FROM CHUNG_TU AS CT, CHUNG_TU_NVKT AS CTNVKT, NGHIEP_VU_KE_TOAN AS NVKT, CDKT_TAIKHOAN AS CDKT, TAI_KHOAN_DANH_MUC AS TKDM 
WHERE CT.MA_CT=CTNVKT.MA_CT AND CTNVKT.MA_NVKT=NVKT.MA_NVKT AND SUBSTRING(NVKT.MA_TK, 1, LENGTH(CDKT.MA_TK))=CDKT.MA_TK AND NVKT.MA_TK=TKDM.MA_TK 
	AND TKDM.LUONG_TINH=1 AND NVKT.SO_DU=CDKT.SO_DU AND CT.NGAY_HT >= '2018-1-01' AND CT.NGAY_HT <= '2018-12-31' 
	AND ((CDKT.ASSET_CODE='112' AND ((CDKT.MA_TK='1281' AND (CT.NGAY_TT IS NULL OR CT.NGAY_TT-INTERVAL 3 MONTH <= CT.NGAY_HT)) OR (CDKT.MA_TK='1288' AND (CT.NGAY_TT IS NULL OR CT.NGAY_TT - INTERVAL 3 MONTH <= CURDATE())))) OR 
	(CDKT.ASSET_CODE='123' AND CT.NGAY_TT - INTERVAL 3 MONTH > CURDATE() AND CT.NGAY_TT - INTERVAL 12 MONTH <= CURDATE()) OR 
	(CDKT.ASSET_CODE IN ('131', '132', '133', '135', '136', '137', '141', '149', '155', '311', '312', '315', '316', '318', '319', '320', '321') AND (CT.NGAY_TT IS NULL OR CT.NGAY_TT - INTERVAL 12 MONTH <= CURDATE())) OR 
	(CDKT.ASSET_CODE IN ('151') AND (CT.NGAY_TT IS NULL OR CT.NGAY_TT-INTERVAL 12 MONTH <= CT.NGAY_HT)) OR 
	(CDKT.ASSET_CODE IN ('211', '212', '214', '215', '216', '219', '241', '255', '263', '268', '331', '332', '333', '335', '336', '337', '338', '342') AND CT.NGAY_TT - INTERVAL 12 MONTH > CURDATE()) OR 
	(CDKT.ASSET_CODE IN ('261') AND CT.NGAY_TT-INTERVAL 12 MONTH > CT.NGAY_HT) OR 
	CDKT.ASSET_CODE NOT IN ('112', '123', '131', '132', '133', '135', '136', '137', '141', '149', '151', '155', '211', '212', '214', '215', '216', '219', '241', '255', '261', '263', '268', 
		'311', '312', '315', '316', '318', '319', '320', '321', '331', '332', '333', '335', '336', '337', '338', '342')) 
GROUP BY CDKT.ASSET_CODE, CDKT.MA_TK
ORDER BY ASSET_CODE, MA_TK

-- 137 & 219 đều lấy từ 2293 (CO), chỉ phân biệt bằng ngay_tt - CURDATE() nhỏ hơn hoặc lớn hơn 12 
-- 155 & 268 đều lấy từ 2288 (NO), chỉ phân biệt bằng ngay_tt - CURDATE() nhỏ hơn hoặc lớn hơn 12

-- 140=141+149 có một số điều chưa phân tách, liên quan đến hàng tồn kho => đều là ngắn hạn, nhỏ hơn 12 tháng
-- + 141: 151 + 152 + 153 + 154 + 155 + 156 + 157
-- + 149: Dự phòng giảm giá hàng tồn kho => 2294 (CO): dự phòng giảm giá cho các khoản nếu trong 141, hiện tại dùng ngưỡng nhỏ hơn 12 tháng để phân 
-- 240=241+242: tài sản dở dang dài hạn
-- + 241: chi phí sản xuất, kinh doanh dở dang dự định thu hồi dài trên 12 tháng => 154 (NO) + 2294 (CO) 
-- + 242: Chi phí xây dựng cơ bản dở => 241 NO => không cần
-- 263: Thiết bị, vật tư, phụ tùng thay thế dài hạn 
-- + 1534 (NO): Thiết bị, phụ tùng thay thế > 12 tháng
-- + 2294 (CO): hiện tại 263 và 241 bị trùng nhau, 2294 (CO) đều phần định là trên 12 tháng, nhưng cần phân định 2 cái này trong tương lai







